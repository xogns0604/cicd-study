pipeline {
    agent any
    
    tools {
        jdk 'jdk17'
    }
    
    environment {
        DOCKER_IMAGE = 'your-project'
        DOCKER_TAG = "${BUILD_NUMBER}"
    }
    
    // PR 머지 이벤트만 감지하도록 설정
    triggers {
        githubPush(
            branches: ['main', 'master']  // main 또는 master 브랜치에 머지될 때만 실행
        )
    }
    
    stages {
        stage('Check Branch') {
            steps {
                script {
                    def branch = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                    if (!(branch in ['main', 'master'])) {
                        error("CD pipeline should only run on main/master branch. Current branch: ${branch}")
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh '''
                    chmod +x ./gradlew
                    ./gradlew clean build -x test
                '''
            }
        }
        
        stage('Docker Build') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                }
            }
        }
        
        stage('Docker Deploy') {
            steps {
                sh '''
                    # 기존 컨테이너 중지 및 제거
                    docker ps -f name=your-project -q | xargs --no-run-if-empty docker stop
                    docker ps -a -f name=your-project -q | xargs --no-run-if-empty docker rm
                    
                    # 새 버전 배포
                    docker run -d \
                        --name your-project \
                        -p 8080:8080 \
                        ${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
        }
        
        stage('Health Check') {
            steps {
                sh '''
                    sleep 30  # 애플리케이션 시작 대기
                    curl -f http://localhost:8080/actuator/health || exit 1
                '''
            }
        }
    }
    
    post {
        success {
            echo 'CD Pipeline succeeded!'
        }
        failure {
            echo 'CD Pipeline failed!'
            sh '''
                docker stop your-project
                docker rm your-project
                docker run -d \
                    --name your-project \
                    -p 8080:8080 \
                    ${DOCKER_IMAGE}:${BUILD_NUMBER.toInteger() - 1}
            '''
        }
        always {
            sh '''
                docker images ${DOCKER_IMAGE} --format "{{.ID}}" | 
                sort -r | 
                tail -n +4 | 
                xargs --no-run-if-empty docker rmi
            '''
        }
    }
}
